<% valuation = local_assigns.fetch(:valuation, false) %>
<% allow_comments = local_assigns.fetch(:allow_comments, true) %>
<% cache [locale_and_user_status, @current_order, commentable_cache_key(@investment), @comment_tree.comments, @comment_tree.comment_authors, @investment.comments_count, @comment_flags] do %>
  <section class="expanded comments">
    <div class="row">
      <div id="comments" class="small-12 column">
        <h2>
          <%= t("debates.show.comments_title") %>
          <span class="js-comments-count">(<%= @investment.comments_count %>)</span>
        </h2>

        <%= render "shared/wide_order_selector", i18n_namespace: "comments" %>

        <% if user_signed_in? && allow_comments %>
          <%= render "comments/form", { commentable: @investment,
                                        parent_id: nil,
                                        toggeable: false,
                                        valuation: valuation } %>
        <% else %>
          <br>
          <%= render "shared/login_to_comment" %>
        <% end %>

        <% if comment_tree.first_comment.present? %>
          <h3><%= t("legislation.questions.comments.original_version") %></h3>
          <%= render "comments/comment", { comment: comment_tree.first_comment,
                                           valuation: valuation,
                                           allow_comments: allow_comments } %>
        <% end %>

        <% comment_tree.root_comments.each do |comment| %>
          <% unless comment == comment_tree.first_comment %>
            <% section = comment_tree.commentable.title.split(" ").first %>
            <h3><%= t("legislation.questions.comments.proposed_amendment_for", section: section) %></h3>
            <%= render "comments/comment", { comment: comment,
                                             valuation: valuation,
                                             allow_comments: allow_comments } %>
          <% end %>
        <% end %>



        <%= paginate @comment_tree.root_comments %>
      </div>
    </div>
  </section>
<% end %>
